name: widget-server pipe

on:
    push:
        branches:
            - 'main'
jobs:
    Build:
        name: Build
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              id: checkout
              uses: actions/checkout@v4

            - name: Configure Node
              id: configure-node
              uses: actions/setup-node@v6
              with:
                node-version: 25.2.1

            - name: Install pnpm
              id: install-pnpm
              uses: pnpm/action-setup@v4
              with:
                version: 10

            - name: Install dependencies
              id: install-dependecies
              run: |
                  pnpm install

            - name: Configure AWS credentials
              id: configure-aws-credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                aws-region: ${{ vars.AWS_REGION }}

            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v2

            - name: Generate Tag
              id: generate_tag
              run: |
                SHA=$(echo $GITHUB_SHA | head -c7)
                echo "sha=$SHA" >> $GITHUB_OUTPUT

            - name: Build and push the image to AWS ECR
              uses: docker/build-push-action@v6
              with:
                context: .
                push: true
                tags: ${{ steps.login-ecr.outputs.registry }}/${{ vars.ECR_REPOSITORY }}:${{steps.generate_tag.outputs.sha}}